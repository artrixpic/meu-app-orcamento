{% extends "base.html" %}
{% block content %}

<form id="budgetForm" method="POST" class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8 pb-20 no-print" onsubmit="prepareSubmit()">
    
    <div class="lg:col-span-2 space-y-6">
        <div class="glass p-6 rounded-2xl space-y-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">
                    {% if budget %}‚úèÔ∏è Editando{% else %}‚ú® Novo Or√ßamento{% endif %}
                </h2>
                <select onchange="fillClient(this)" class="bg-neon-500/10 border border-neon-500/30 text-neon-500 text-xs rounded-lg p-2 font-bold focus:outline-none">
                    <option value="">‚ö° Importar Cliente...</option>
                    {% for c in clients %}
                    <option value="{{ c.id }}" data-cnpj="{{ c.cnpj }}" data-phone="{{ c.phone }}" data-address="{{ c.address }}">{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="text-xs text-gray-500 ml-1">Cliente</label>
                    <input type="text" name="client" id="input_client" value="{{ budget.client if budget else '' }}" required class="bg-dark-900 border border-dark-700 rounded-lg p-3 text-white w-full" oninput="updatePrintView()">
                </div>
                <div>
                    <label class="text-xs text-gray-500 ml-1">CNPJ / CPF</label>
                    <input type="text" name="client_cnpj" id="input_client_cnpj" value="{{ budget.client_cnpj if budget else '' }}" class="bg-dark-900 border border-dark-700 rounded-lg p-3 text-white w-full" oninput="updatePrintView()">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="text-xs text-gray-500 ml-1">Endere√ßo</label>
                    <input type="text" name="client_address" id="input_client_address" value="{{ budget.client_address if budget else '' }}" class="bg-dark-900 border border-dark-700 rounded-lg p-3 text-white w-full" oninput="updatePrintView()">
                </div>
                <div>
                    <label class="text-xs text-gray-500 ml-1">WhatsApp</label>
                    <input type="text" name="client_phone" id="input_phone" value="{{ budget.client_phone if budget else '' }}" class="bg-dark-900 border border-dark-700 rounded-lg p-3 text-white w-full" oninput="updatePrintView()">
                </div>
            </div>

            <label class="text-xs text-gray-500 ml-1 mt-2 block">T√≠tulo do Projeto</label>
            <input type="text" name="title" id="input_title" value="{{ budget.title if budget else '' }}" required class="bg-dark-900 border border-dark-700 rounded-lg p-3 text-white w-full" oninput="updatePrintView()">
            
            <label class="text-xs text-gray-500 ml-1 mt-2 block">Escopo</label>
            <textarea name="description" id="input_desc" rows="4" class="w-full bg-dark-900 border border-dark-700 rounded-lg p-3 text-white text-sm" oninput="updatePrintView()">{{ budget.description if budget else '' }}</textarea>
        </div>

        <div class="glass p-6 rounded-2xl border border-dark-700/50">
            <h3 class="text-sm font-bold text-gray-400 mb-4 uppercase">Recursos</h3>
            <div class="mb-4 flex items-center gap-4 bg-dark-900 p-3 rounded-lg">
                <span class="text-blue-400">üë∑ Minhas Di√°rias:</span>
                <input type="number" name="labor_days" id="labor_days" value="{{ budget.labor_days if budget else 1 }}" min="0" step="0.5" class="w-20 bg-dark-800 border border-dark-700 rounded p-1 text-center text-white" oninput="calculateTotal()">
                <input type="hidden" id="base_daily_rate" value="{{ config.hourly_rate * 8 }}">
            </div>
            <div class="mb-4 bg-dark-900 p-3 rounded-lg">
                <div class="flex justify-between mb-2"><span class="text-purple-400">ü§ù Equipe:</span> <span class="text-gray-400" id="freela_display">0.00</span></div>
                <div id="freela_list_editor" class="space-y-1 mb-2"></div>
                <div class="flex gap-2">
                    <select id="freela_select" class="flex-1 bg-dark-800 border border-dark-700 rounded p-1 text-white text-xs">
                        <option value="0">Selecionar...</option>
                        {% for f in freelas %}<option value="{{ f.daily_rate }}">{{ f.name }} - {{ f.role }}</option>{% endfor %}
                    </select>
                    <button type="button" onclick="addFromSelect('freela')" class="bg-purple-600 px-3 rounded text-white font-bold text-xs">+</button>
                </div>
            </div>
            <div class="mb-4 bg-dark-900 p-3 rounded-lg">
                <div class="flex justify-between mb-2"><span class="text-neon-400">üì∑ Equipamento:</span> <span class="text-gray-400" id="gear_display">0.00</span></div>
                <div id="gear_list_editor" class="space-y-1 mb-2"></div>
                <div class="flex gap-2">
                    <select id="gear_select" class="flex-1 bg-dark-800 border border-dark-700 rounded p-1 text-white text-xs">
                        <option value="0">Selecionar...</option>
                        {% for g in gears %}<option value="{{ g.rental_value }}">{{ g.name }}</option>{% endfor %}
                    </select>
                    <button type="button" onclick="addFromSelect('gear')" class="bg-neon-600 px-3 rounded text-white font-bold text-xs">+</button>
                </div>
            </div>
            <div class="flex items-center gap-4 bg-dark-900 p-3 rounded-lg">
                <span class="text-yellow-400">üöó Extras:</span>
                <input type="number" id="extra_cost" name="extra_cost_input" value="{{ budget.extra_cost if budget else 0 }}" class="w-full bg-dark-800 border border-dark-700 rounded p-1 text-white" oninput="calculateTotal()">
            </div>
        </div>
    </div>

    <div class="lg:col-span-1">
        <div class="glass p-6 rounded-2xl sticky top-4 border border-neon-500/30">
            <h3 class="text-xl font-bold text-white mb-6">Fechamento</h3>
            <div class="space-y-4 text-sm mb-6">
                <div class="flex justify-between text-gray-400 mb-1">
                    <span>Margem</span>
                    <span class="text-neon-400 font-bold"><span id="margin_display">30</span>%</span>
                </div>
                <input type="range" name="margin_range" id="margin_range" min="10" max="60" value="{{ budget.margin_percent if budget else 30 }}" class="w-full accent-neon-500" oninput="calculateTotal()">
                <div class="flex justify-between text-gray-400 mb-1">
                    <span>Imposto (NF)</span>
                    <div class="flex items-center gap-1"><input type="number" id="tax_input" value="6" class="w-10 bg-dark-900 text-center rounded text-xs" oninput="calculateTotal()"> %</div>
                </div>
            </div>
            <div class="border-t border-dark-700 pt-6 text-center">
                <p class="text-gray-400 text-xs uppercase mb-1">Valor Final</p>
                <p class="text-4xl font-bold text-neon-500 mb-2" id="final_price_display">R$ 0,00</p>
            </div>
            <input type="hidden" name="final_price_input" id="final_price_input">
            <input type="hidden" name="items_json" id="items_json">
            <div class="mt-8 space-y-3">
                <button type="button" onclick="saveBudget()" class="w-full bg-neon-500 hover:bg-neon-600 text-dark-900 font-bold py-3 rounded-xl transition">üíæ Salvar</button>
                <button type="button" onclick="window.print()" class="w-full bg-white hover:bg-gray-200 text-black font-medium py-3 rounded-xl transition flex items-center justify-center gap-2">üñ®Ô∏è PDF Cliente</button>
            </div>
        </div>
    </div>
</form>

<div id="print-area" class="hidden print-visible bg-white text-black p-12 max-w-4xl mx-auto min-h-screen">
    <div class="flex justify-between items-start border-b-4 pb-6 mb-8" style="border-color: {{ config.brand_color }};">
        <div class="w-2/3">
            {% if config.logo_url %}
            <img src="{{ config.logo_url }}" alt="Logo" class="h-20 object-contain mb-3">
            {% else %}
            <h1 class="text-3xl font-bold uppercase tracking-widest mb-1" style="color: {{ config.brand_color }};">{{ config.company_name }}</h1>
            {% endif %}
            <p class="text-xs text-gray-500">{{ config.address }}</p>
            {% if config.cnpj %}<p class="text-xs text-gray-500">CNPJ: {{ config.cnpj }}</p>{% endif %}
            {% if config.whatsapp %}<p class="text-xs text-gray-500">Contato: {{ config.whatsapp }}</p>{% endif %}
        </div>
        <div class="text-right w-1/3">
            <p class="text-sm font-bold uppercase" style="color: {{ config.brand_color }};">Proposta Comercial</p>
            <p class="text-sm text-gray-500">Data: <span id="print_date"></span></p>
        </div>
    </div>
    <div class="mb-8 bg-gray-50 p-6 rounded-lg border-l-4" style="border-color: {{ config.brand_color }};">
        <p class="text-xs text-gray-400 uppercase tracking-wider mb-2">Preparado para:</p>
        <h2 class="text-xl font-bold text-gray-800" id="print_client">Nome do Cliente</h2>
        <p class="text-sm text-gray-600 mt-1" id="print_client_cnpj">CNPJ/CPF...</p>
        <p class="text-sm text-gray-600" id="print_client_address">Endere√ßo...</p>
        <p class="text-sm text-gray-600 mt-2 font-medium" id="print_title">Projeto</p>
    </div>
    <div class="mb-8">
        <h3 class="text-sm font-bold border-b pb-2 mb-4 uppercase tracking-wider" style="border-color: #ddd; color: {{ config.brand_color }};">Escopo</h3>
        <div id="print_desc" class="text-gray-700 leading-relaxed whitespace-pre-wrap text-justify text-sm"></div>
    </div>
    <div class="mb-10 grid grid-cols-2 gap-8">
        <div>
            <h3 class="text-sm font-bold border-b pb-2 mb-3 uppercase tracking-wider" style="border-color: #ddd; color: {{ config.brand_color }};">Equipe T√©cnica</h3>
            <ul class="text-xs text-gray-700 space-y-2 list-disc pl-4" id="print_crew_list"></ul>
        </div>
        <div>
            <h3 class="text-sm font-bold border-b pb-2 mb-3 uppercase tracking-wider" style="border-color: #ddd; color: {{ config.brand_color }};">Equipamentos</h3>
            <ul class="text-xs text-gray-700 space-y-2 list-disc pl-4" id="print_gear_list"></ul>
        </div>
    </div>
    <div class="mb-16 text-right pt-6 border-t-2" style="border-color: {{ config.brand_color }};">
        <p class="text-sm text-gray-500 mb-1">Investimento Total</p>
        <div class="text-5xl font-bold tracking-tight" style="color: {{ config.brand_color }};" id="print_price">R$ 0,00</div>
        <p class="text-xs text-gray-400 mt-2">*Incluso nota fiscal e encargos t√©cnicos.</p>
    </div>
    <div class="text-center text-xs text-gray-400 mt-auto"><p>{{ config.company_name }} ¬© {{ 2024 }}</p></div>
</div>

<style>@media print { body * { visibility: hidden; } .no-print { display: none !important; } #print-area, #print-area * { visibility: visible; display: block; } #print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 40px; background: white; color: black; } .grid { display: grid !important; } .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; } .gap-8 { gap: 2rem !important; } .flex { display: flex !important; } .justify-between { justify-content: space-between !important; } .text-right { text-align: right !important; } } .hidden { display: none; }</style>

<script>
    let currentItems = [];

    window.onload = function() {
        {% if budget %}
        try {
            const savedData = {{ budget.get_items_json() | safe }};
            if(savedData && savedData.length > 0) {
                savedData.forEach(item => { currentItems.push({ name: item.name, value: item.value, type: item.type }); });
                renderLists();
            }
        } catch(e) { console.log(e); }
        {% endif %}
        calculateTotal();
    }

    // AQUI EST√Å A M√ÅGICA: Preenche os dados quando seleciona no menu
    function fillClient(select) {
        const option = select.options[select.selectedIndex];
        if (option.value === "") return;

        document.getElementById('input_client').value = option.text;
        document.getElementById('input_client_cnpj').value = option.getAttribute('data-cnpj');
        document.getElementById('input_client_address').value = option.getAttribute('data-address');
        document.getElementById('input_phone').value = option.getAttribute('data-phone');
        
        // Atualiza o PDF na hora pra pessoa ver
        updatePrintView();
    }

    function saveBudget() {
        document.getElementById('items_json').value = JSON.stringify(currentItems);
        document.getElementById('budgetForm').submit();
    }

    function addFromSelect(type) {
        const select = document.getElementById(type + '_select');
        const value = parseFloat(select.value);
        const name = select.options[select.selectedIndex].text;
        if(value > 0) addItem(name, value, type);
    }

    function addItem(name, value, type) {
        currentItems.push({ name: name, value: value, type: type });
        renderLists();
        calculateTotal();
    }

    function removeItem(index) {
        currentItems.splice(index, 1);
        renderLists();
        calculateTotal();
    }

    function renderLists() {
        const gearList = document.getElementById('gear_list_editor');
        const freelaList = document.getElementById('freela_list_editor');
        gearList.innerHTML = '';
        freelaList.innerHTML = '';
        currentItems.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center bg-dark-800 p-2 rounded text-xs text-gray-300 item-row mb-1';
            div.innerHTML = `<span>${item.name}</span> <button type="button" onclick="removeItem(${index})" class="text-red-500 font-bold no-print">x</button>`;
            if(item.type === 'gear') gearList.appendChild(div);
            else freelaList.appendChild(div);
        });
        updatePrintView();
    }

    function calculateTotal() {
        const baseDaily = parseFloat(document.getElementById('base_daily_rate').value) || 0;
        const days = parseFloat(document.getElementById('labor_days').value) || 0;
        const extraCost = parseFloat(document.getElementById('extra_cost').value) || 0;
        let freelaSum = 0; let gearSum = 0;
        currentItems.forEach(item => { if(item.type === 'freela') freelaSum += item.value; if(item.type === 'gear') gearSum += item.value; });
        const totalCost = (baseDaily * days) + extraCost + freelaSum + gearSum;
        const margin = parseFloat(document.getElementById('margin_range').value) || 0;
        const tax = parseFloat(document.getElementById('tax_input').value) || 0;
        const divisor = 1 - ((margin + tax) / 100);
        const finalPrice = divisor > 0 ? totalCost / divisor : 0;
        const moneyFormat = finalPrice.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        document.getElementById('final_price_display').innerText = moneyFormat;
        document.getElementById('print_price').innerText = moneyFormat;
        document.getElementById('margin_display').innerText = margin;
        document.getElementById('final_price_input').value = finalPrice;
        document.getElementById('freela_display').innerText = freelaSum.toFixed(2);
        document.getElementById('gear_display').innerText = gearSum.toFixed(2);
        updatePrintView();
    }

    function updatePrintView() {
        document.getElementById('print_client').innerText = document.getElementById('input_client').value || 'Cliente...';
        document.getElementById('print_client_cnpj').innerText = document.getElementById('input_client_cnpj').value || '';
        document.getElementById('print_client_address').innerText = document.getElementById('input_client_address').value || '';
        document.getElementById('print_title').innerText = document.getElementById('input_title').value || 'Projeto...';
        document.getElementById('print_desc').innerText = document.getElementById('input_desc').value || '';
        document.getElementById('print_date').innerText = new Date().toLocaleDateString('pt-BR');
        const crewList = document.getElementById('print_crew_list');
        const gearList = document.getElementById('print_gear_list');
        crewList.innerHTML = '';
        gearList.innerHTML = '';
        const days = document.getElementById('labor_days').value;
        if(days > 0) crewList.innerHTML += `<li><strong>Dire√ß√£o / Videomaker:</strong> ${days} di√°rias</li>`;
        currentItems.forEach(item => {
            if(item.type === 'freela') crewList.innerHTML += `<li>${item.name}</li>`;
            if(item.type === 'gear') gearList.innerHTML += `<li>${item.name}</li>`;
        });
    }
</script>
{% endblock %}